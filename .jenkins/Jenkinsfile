#!groovy

if (currentBuild.getBuildCauses().toString().contains('BranchIndexingCause')) {
  print "INFO: Build skipped due being triggered by Branch Indexing instead of SCM change!"
  currentBuild.result = 'ABORTED' // default would be successful: this makes it more clear that is thas been skipped
  return
}

def buildbadge = addEmbeddableBadgeConfiguration(id: "build-and-test-${env.JOB_BASE_NAME}", subject: "CUDA/Kokkos ctest")

pipeline {
    agent { label 'pcsgs05' }
    options {
        buildDiscarder(
            logRotator(
                daysToKeepStr: "21",
                numToKeepStr: "50",
                artifactDaysToKeepStr: "21",
                artifactNumToKeepStr: "50"
            )
        )
        disableConcurrentBuilds()
    }
    triggers {
        githubPush()
    } 
    environment {
        GITHUB_TOKEN = credentials('GITHUB_TOKEN_OCTOTIGER')
    }
    stages {
        stage('checkout') {
            steps {
                script {
		    buildbadge.setStatus('running')
                }
                dir('CPPuddle') {
                    checkout scm
                    sh '''
                        git submodule update --init --recursive
                        ./scripts/clean_dependencies.sh
                    '''
                }
            }
        }
        stage('build-and-test') {
            matrix {
                axes {
                    axis {
                        name 'build_type'
                        values 'Release', 'Debug'
                    }
                    axis {
                        name 'compiler'
                        values 'gcc', 'clang'
                    }
                }
                stages {
                    stage('init') {
                        steps {
                            dir('CPPuddle') {
                                sh '''
                                    github_token=$(echo ${GITHUB_TOKEN} | cut -f2 -d':')
                                    curl --verbose\
                                        --request POST \
                                        --url "https://api.github.com/repos/SC-SGS/CPPuddle/statuses/$GIT_COMMIT" \
                                        --header "Content-Type: application/json" \
                                        --header "authorization: Bearer ${github_token}" \
                                        --data "{
                                            \\"state\\": \\"pending\\",
                                            \\"context\\": \\"jenkins-${compiler}-${build_type}-ctest\\",
                                            \\"description\\": \\"Jenkins CI Job: jenkins-${compiler}-${build_type}-ctest\\",
                                            \\"target_url\\": \\"https://simsgs.informatik.uni-stuttgart.de/jenkins/job/CPPuddle/$BUILD_NUMBER/console\\"
                                    }"
                                '''
                            }
                        }
                    }
                    stage('build-submodules') {
                        steps {
                            dir('CPPuddle') {
                                sh '''
                                    module load cuda
                                    ./scripts/build_dependencies.sh ${build_type} ${compiler}
                                '''
                            }
                        }
                    }
                    stage('build cppuddle') {
                        steps {
                            dir('CPPuddle') {
                                sh '''
                                    module load cuda 
                                    ./scripts/configure_build_directory.sh ${build_type} ${compiler}
                                    cd build/${compiler}-${build_type}
                                    make -j4
                                '''
                            }
                        }
                    }
                    stage('run tests') {
                        steps {
                            dir('CPPuddle') {
                                sh '''
                                    module load cuda
                                    cd build/${compiler}-${build_type}
                                    ctest -j4
                                '''
                            }
                        }
                    }
                }
                post {
                    success {
			script {
			    buildbadge.setStatus('passing')
			}
                        sh '''
                            github_token=$(echo ${GITHUB_TOKEN} | cut -f2 -d':')
                            curl --verbose\
                                --request POST \
                                --url "https://api.github.com/repos/SC-SGS/CPPuddle/statuses/$GIT_COMMIT" \
                                --header "Content-Type: application/json" \
                                --header "authorization: Bearer ${github_token}" \
                                --data "{
                                    \\"state\\": \\"success\\",
                                    \\"context\\": \\"jenkins-${compiler}-${build_type}-ctest\\",
                                    \\"description\\": \\"Jenkins CI Job: jenkins-${compiler}-${build_type}-ctest\\",
                                    \\"target_url\\": \\"https://simsgs.informatik.uni-stuttgart.de/jenkins/job/CPPuddle/$BUILD_NUMBER/console\\"
                            }"
                        '''
                    }
                    failure {
			script {
			    buildbadge.setStatus('failing')
			}
                        sh '''
                            github_token=$(echo ${GITHUB_TOKEN} | cut -f2 -d':')
                            curl --verbose\
                                --request POST \
                                --url "https://api.github.com/repos/SC-SGS/CPPuddle/statuses/$GIT_COMMIT" \
                                --header "Content-Type: application/json" \
                                --header "authorization: Bearer ${github_token}" \
                                --data "{
                                    \\"state\\": \\"failure\\",
                                    \\"context\\": \\"jenkins-${compiler}-${build_type}-ctest\\",
                                    \\"description\\": \\"Jenkins CI Job: jenkins-${compiler}-${build_type}-ctest\\",
                                    \\"target_url\\": \\"https://simsgs.informatik.uni-stuttgart.de/jenkins/job/CPPuddle/$BUILD_NUMBER/console\\"
                            }"
                        '''
                    }
                    aborted {
			script {
			    buildbadge.setStatus('aborted')
			}
                        sh '''
                            github_token=$(echo ${GITHUB_TOKEN} | cut -f2 -d':')
                            curl --verbose\
                                --request POST \
                                --url "https://api.github.com/repos/SC-SGS/CPPuddle/statuses/$GIT_COMMIT" \
                                --header "Content-Type: application/json" \
                                --header "authorization: Bearer ${github_token}" \
                                --data "{
                                    \\"state\\": \\"error\\",
                                    \\"context\\": \\"jenkins-${compiler}-${build_type}-ctest\\",
                                    \\"description\\": \\"Jenkins CI Job: jenkins-${compiler}-${build_type}-ctest\\",
                                    \\"target_url\\": \\"https://simsgs.informatik.uni-stuttgart.de/jenkins/job/CPPuddle/$BUILD_NUMBER/console\\"
                            }"
                        '''
                    }
                }
            }
        }
    }
}
